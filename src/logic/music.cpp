#include "music.h"

#include "config.h"
#include "musicPlayer.h"
#include "pixels.h"

#include <array>
#include <cmath>
#include <ctime>
#include <cctype>
#include <cstring>
#include <memory>

namespace {
  using Song = std::vector<const char*>;
  Song inTheHallOfTheMountainKing = {
    "T:138 K:D B1/8 R/64 C#2/8 R/64 D2/8 R/64 E2/8 R/64 F#2/8 R/64 D2/8 R/64 F#2/4 R/64 F2/8 R/64 C#2/8 R/64 F2/4 R/64 E2/8 R/64 C2/8 R/64 E2/4 R/64 B1/8 R/64 C#2/8 R/64 D2/8 R/64 E2/8 R/64 F#2/8 R/64 D2/8 R/64 F#2/8 R/64 B2/8 R/64 A2/8 R/64 F#2/8 R/64 D2/8 R/64 F#2/8 R/64 A2/2 R/64 B2/8 R/64 C#3/8 R/64 D3/8 R/64 E3/8 R/64 F#3/8 R/64 D3/8 R/64 F#3/4 R/64 F3/8 R/64 C#3/8 R/64 F3/4 R/64 E3/8 R/64 C3/8 R/64 E3/4 R/64 B2/8 R/64 C#3/8 R/64 D3/8 R/64 E3/8 R/64 F#3/8 R/64 D3/8 R/64 F#3/8 R/64 B3/8 R/64 A3/8 R/64 F#3/8 R/64 D3/8 R/64 F#3/8 R/64 A3/2 R/64 F#2/8 R/64 G#2/8 R/64 A#2/8 R/64 B2/8 R/64 C#3/8 R/64 A#2/8 R/64 C#3/4 R/64 D3/8 R/64 A#2/8 R/64 D3/4 R/64 C#3/8 R/64 A#2/8 R/64 C#3/4 R/64 F#2/8 R/64 G#2/8 R/64 A#2/8 R/64 B2/8 R/64 C#3/8 R/64 A#2/8 R/64 C#3/4 R/64 D3/8 R/64 A#2/8 R/64 D3/4 R/64 C#3/4 R/4 F#3/8 R/64 G#3/8 R/64 A#3/8 R/64 B3/8 R/64 C#4/8 R/64 A#3/8 R/64 C#4/4 R/64 D4/8 R/64 A#3/8 R/64 D4/4 R/64 C#4/8 R/64 A#3/8 R/64 C#4/4 R/64 F#3/8 R/64 G#3/8 R/64 A#3/8 R/64 B3/8 R/64 C#4/8 R/64 A#3/8 R/64 C#4/4 R/64 D4/8 R/64 A#3/8 R/64 D4/4 R/64 C#4/4 R/4 B1/8 R/64 C#2/8 R/64 D2/8 R/64 E2/8 R/64 F#2/8 R/64 D2/8 R/64 F#2/4 R/64 F2/8 R/64 C#2/8 R/64 F2/4 R/64 E2/8 R/64 C2/8 R/64 E2/4 R/64 B1/8 R/64 C#2/8 R/64 D2/8 R/64 E2/8 R/64 F#2/8 R/64 D2/8 R/64 F#2/8 R/64 B2/8 R/64 A2/8 R/64 F#2/8 R/64 D2/8 R/64 F#2/8 R/64 A2/2 R/64 B2/8 R/64 C#3/8 R/64 D3/8 R/64 E3/8 R/64 F#3/8 R/64 D3/8 R/64 F#3/4 R/64 F3/8 R/64 C#3/8 R/64 F3/4 R/64 E3/8 R/64 C3/8 R/64 E3/4 R/64 B2/8 R/64 C#3/8 R/64 D3/8 R/64 E3/8 R/64 F#3/8 R/64 D3/8 R/64 F#3/8 R/64 B3/8 R/64 F#3/8 R/64 D3/8 R/64 F#3/8 R/64 B3/8 R/64 B2/2 R/64 B3/8 R/64 C#4/8 R/64 D4/8 R/64 E4/8 R/64 F#4/8 R/64 D4/8 R/64 F#4/4 R/64 F4/8 R/64 C#4/8 R/64 F4/4 R/64 E4/8 R/64 C4/8 R/64 E4/4 R/64 B3/8 R/64 C#4/8 R/64 D4/8 R/64 E4/8 R/64 F#4/8 R/64 D4/8 R/64 F#4/8 R/64 B4/8 R/64 A4/8 R/64 F#4/8 R/64 D4/8 R/64 F#4/8 R/64 A4/2 R/64 B4/8 R/64 C#5/8 R/64 D5/8 R/64 E5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/4 R/64 F5/8 R/64 C#5/8 R/64 F5/4 R/64 E5/8 R/64 C5/8 R/64 E5/4 R/64 B4/8 R/64 C#5/8 R/64 D5/8 R/64 E5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/8 R/64 B5/8 R/64 A5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/8 R/64 A5/2 R/64 F#4/8 R/64 G#4/8 R/64 A#4/8 F#4/64 B4/8 R/64 C#5/8 R/64 A#4/8 R/64 C#5/4 R/64 D5/8 R/64 A#4/8 R/64 D5/4 R/64 C#5/8 R/64 A#4/8 R/64 C#5/4 R/64 F#4/8 R/64 G#4/8 R/64 A#4/8 F#4/64 B4/8 R/64 C#5/8 R/64 A#4/8 R/64 C#5/4 R/64 D5/8 R/64 A#4/8 R/64 D5/4 R/64 C#5/4 R/64 A#4/4 R/64 F#5/8 R/64 G#5/8 R/64 A#5/8 R/64 B5/8 R/64 C#6/8 R/64 A#5/8 R/64 C#6/4 R/64 D6/8 R/64 A#5/8 R/64 D6/4 R/64 C#6/8 R/64 A#5/8 R/64 C#6/4 R/64 F#5/8 R/64 G#5/8 R/64 A#5/8 R/64 B5/8 R/64 C#6/8 R/64 A#5/8 R/64 C#6/4 R/64 D6/8 R/64 A#5/8 R/64 D6/4 R/64 C#6/4 R/64 A#5/4 R/64 B3/8 R/64 C#4/8 R/64 D4/8 R/64 E4/8 R/64 F#4/8 R/64 D4/8 R/64 F#4/4 R/64 F4/8 R/64 C#4/8 R/64 F4/4 R/64 E4/8 R/64 C4/8 R/64 E4/4 R/64 B3/8 R/64 C#4/8 R/64 D4/8 R/64 E4/8 R/64 F#4/8 R/64 D4/8 R/64 F#4/8 R/64 B4/8 R/64 A4/8 R/64 F#4/8 R/64 D4/8 R/64 F#4/8 R/64 A4/2 R/64 B4/8 R/64 C#5/8 R/64 D5/8 R/64 E5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/4 R/64 F5/8 R/64 C#5/8 R/64 F5/4 R/64 E5/8 R/64 C5/8 R/64 E5/4 R/64 B4/8 R/64 C#5/8 R/64 D5/8 R/64 E5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/8 R/64 B5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/8 D5/64 B5/8 R/64 B4/2 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/4 B5/64 F#6/4 R/64 F6/4 B5/64 F6/4 R/64 E6/4 B5/64 E6/4 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/4 B5/64 F#6/8 B5/64 B6/8 R/64 A6/4 A5/64 D6/8 F#6/8 R/64 A6/2 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/4 B5/64 F#6/4 R/64 F6/4 B5/64 F6/4 R/64 E6/4 B5/64 E6/4 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/4 B5/64 F#6/8 B5/64 B6/8 R/64 A6/4 R/64 D6/8 F#6/8 R/64 A6/2 R/64 F#6/8 R/64 G#6/8 R/64 A#6/8 R/64 B6/8 R/64 C#7/8 F#6/64 A#6/8 R/64 C#7/4 R/64 D7/8 R/64 A#6/8 R/64 D7/4 R/64 C#7/8 R/64 A#6/8 R/64 C#7/4 R/64 F#6/8 R/64 G#6/8 R/64 A#6/8 R/64 B6/8 R/64 C#7/8 R/64 A#6/8 R/64 C#7/4 R/64 D7/8 R/64 A#6/8 R/64 D7/4 R/64 C#7/4 F#6/4 R/64 F#6/8 R/64 G#6/8 R/64 A#6/8 R/64 B6/8 R/64 C#7/8 F#6/64 A#6/8 R/64 C#7/4 R/64 D#7/8 R/64 A#6/8 R/64 D#7/4 R/64 C#7/8 R/64 A#6/8 R/64 C#7/4 R/64 F#6/8 R/64 G#6/8 R/64 A#6/8 R/64 B6/8 R/64 C#7/8 R/64 A#6/8 R/64 C#7/4 R/64 D#7/8 R/64 A#6/8 R/64 D#7/4 R/64 C#7/4 F#6/4 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/4 B5/64 F#6/4 R/64 F6/4 B5/64 F6/4 R/64 E6/4 B5/64 E6/4 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/4 B5/64 F#6/8 B5/64 B6/8 R/64 A6/4 A5/64 D6/8 F#6/8 R/64 A6/2 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/8 R/64 D6/8 R/64 F#6/4 R/64 F6/8 R/64 C#6/8 R/64 F6/4 R/64 E6/8 R/64 C6/8 R/64 E6/4 R/64 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/8 R/64 D6/8 R/64 F#6/8 R/64 B6/8 R/64 F#6/8 R/64 D6/8 R/64 F#6/8 R/64 B6/8 R/64 B5/2 R/16. G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/2 G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/2 B4/8 R/64 C#5/8 R/64 D5/8 R/64 E5/8 R/64 F#5/8 R/64 D5/8 R/64 F#5/8 R/64 B5/8 R/64 A#5/8 R/64 F#5/8 R/64 A#5/8 R/64 C#6/8 R/64 B5/2 R/16. G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/2 G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/2 B5/8 R/64 C#6/8 R/64 D6/8 R/64 E6/8 R/64 F#6/8 R/64 D6/8 R/64 F#6/8 R/64 B6/8 R/64 A#6/8 R/64 F#6/8 R/64 A#6/8 R/64 C#7/8 R/64 B6/2 R/16. G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/2 G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/2 G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4 R/64 B6/4 R/64 B6/4 R/64 G#6/32. R/64 A6/16. G#6/64 A#6/64. G#6/64 A6/64. B6/32. G#6/64 A#6/32. R/64 B6/4 R/64 B6/4 R/64 B6/4 R/1. G#6/32. R/64 A6/16. R/64 A#6/32. R/64 B6/4",
  };
  Song test = {
    "T:90 K:C C4/4 D4/4 C4/4 D4/4 | C4/4      D4/4      C4/4 D4/4 | C4/4 D4/4",
    "T:90 K:C C3/2      C3/2      | D3/8 E3/8 F3/8 G3/8 C4/4 D4/4 | C4/4 D4/4"
  };
  Song odeAnDieFreude = {
    "T:120 K:C F#3/2 G3/4 A3/2 G3/4 F#3/4 E3/4 D3/2 E3/4 F#3/2 E3/4. R/4 F#3/2 G3/4 A3/2 G3/4 F#3/4 E3/4 D3/2 E3/4 F#3/4 E3/4. D3/4. R/4 E3/2 F#3/4 D3/4 E3/4 F#3/8 G3/8 R/64 F#3/4 D3/4 E3/4 F#3/8 G3/8 R/64 F#3/4 E3/4 D3/4 E3/4 A2/4 F#3/2. G3/4 A3/2 G3/4 F#3/4 E3/4 D3/2 E3/4 F#3/4 E3/4. D3/4. R/4 E3/2 F#3/4 D3/4 E3/4 F#3/8 G3/8 R/64 F#3/4 D3/4 E3/4 F#3/8 G3/8 R/64 F#3/4 E3/4 D3/4 E3/4 A2/4 F#3/2. G3/4 A3/2 G3/4 F#3/4 E3/4 D3/2 E3/4 F#3/4 E3/4. D3/4."
  };
  Song tetrisB = {
    "T:145 K:D E4/8 R/64 E4/16 R/64 E4/16 R/64 B3/8 R/64 B3/8 R/64 E4/8 R/64 E4/16 R/64 E4/16 R/64 B3/8 R/64 B3/8 R/64 E4/8 R/64 E4/16 R/64 E4/16 R/64 B3/8 R/64 B3/8 R/64 E4/8 R/64 E4/16 R/64 E4/16 R/64 B3/8 R/64 B3/8 R/64 E4/8 R/64 B4/8 R/64 E5/8 R/64 D#5/8 R/64 E5/8 R/64 B4/16 R/64 B4/16 R/64 C5/8 R/64 A4/8 R/64 B4/8 R/64 F#4/16 R/64 G4/16 R/64 A4/8 R/64 F#4/8 R/64 G4/8 R/64 E4/16 R/64 E4/16 R/64 F#4/8 R/64 D#4/8 R/64 E4/8 R/64 B3/8 R/64 C4/8 R/64 D#4/8 R/64 E4/8 R/64 B3/8 R/64 C4/8 R/64 F#4/8 R/64 E4/4 R/2 R/64 F#4/8 R/64 D#4/8 R/64 E4/4 R/2 R/64 F#4/4 R/64 G4/8 R/64 G4/16 R/64 G4/16 R/64 A4/8 R/64 F#4/8 R/64 G4/8 R/64 G4/16 R/64 G4/16 R/64 A4/8 R/64 F#4/8 R/64 G4/4 R/2 R/64 A4/4 R/64 B4/8 R/64 B4/16 R/64 B4/16 R/64 C5/8 R/64 A4/8 R/64 B4/8 R/64 B4/16 R/64 B4/16 R/64 C5/8 R/64 A4/8 R/64 B4/4 R/2 R/64 C#5/4 R/64 D5/8 R/64 D5/16 R/64 D5/16 R/64 D5/8 R/64 D5/8 R/64 E5/8 R/64 D5/8 R/64 D5/8 R/64 C#5/8 R/64 D5/8 R/64 D5/16 R/64 D5/16 R/64 D5/8 R/64 D5/8 R/64 E5/8 R/64 D5/8 R/64 D5/8 R/64 C#5/8 R/64 D5/8 R/64 D5/16 R/64 D5/16 R/64 D5/8 R/64 D5/8 R/64 C#5/8 R/64 C#5/16 R/64 C#5/16 R/64 C#5/8 R/64 C#5/8 R/64 C5/8 R/64 C5/16 R/64 C5/16 R/64 C5/8 R/64 A4/8 R/64 F#4/8 R/64 G4/8 R/64 A4/8 R/64 D4/8 R/64 A4/8 R/64 G4/16 R/64 G4/16 R/64 D4/8 R/64 G4/8 R/8 R/64 D4/16 R/64 E4/16 R/64 D4/8 R/64 B3/8 R/64 A4/8 R/64 G4/16 R/64 G4/16 R/64 D4/8 R/64 G4/8 R/8 R/64 D4/16 R/64 E4/16 R/64 D4/8 R/64 A#3/8 R/64 D4/4 R/1. R/64 D#4/4",
    "T:145 K:D E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 B1/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 C2/8 R/64 A1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 D#2/8 R/64 B1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 C2/8 R/64 A1/8 R/64 E2/8 R/64 E2/16 R/64 E2/16 R/64 D2/8 R/64 D1/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 D3/16 R/64 A2/8 R/64 A3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 G2/16 R/64 G2/8 R/64 G3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 G2/8 R/64 G3/16 R/64 G2/16 R/64 G2/8 R/64 G3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 F#3/8 R/64 E3/8 R/64 E3/16 R/64 E3/16 R/64 E3/8 R/64 E3/8 R/64 E3/8 R/64 E3/16 R/64 E3/16 R/64 E3/8 R/64 E3/8 R/64 D#3/8 R/64 D#3/16 R/64 D#3/16 R/64 D#3/8 R/64 D#3/8 R/64 D#3/8 R/64 D#3/16 R/64 D#3/16 R/64 D#3/8 R/64 D#3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D2/8 R/64 D3/8 R/64 D2/8 R/64 D3/16 R/64 D2/16 R/64 D#2/8 R/64 D#3/8"
  };
  std::array<std::unique_ptr<Player>, BUZZER_PINS.size()> players;

  void play(const Song& song) {
    const auto now = Player::now();
    for(int i = 0; i < BUZZER_PINS.size() && i < song.size(); ++i) {
      players[i] = std::make_unique<Player>(song[i], BUZZER_PINS[i], now);
    }
  }

} // namespace

void MusicState::enter() {
  play(test);
}

void MusicState::update() {
  for(auto &player : players) {
    if(player) {
      player->loop();
    }
  }
}

void MusicState::exit() {
  for(auto &player : players) {
    player.reset();
  }
  for (int i = 0; i < BUZZER_PINS.size(); ++i) {
    Buzzer::off(i);
  }
  Pixels::clear();
}
